import{$ as e,a0 as t,a1 as n}from"./popup.js";const o="/logs",r=new TextDecoder("utf-8");let s,a,l,c,i=!1,u=!1,g="";function d(e,t){let o;try{o=JSON.parse(e)}catch(a){console.log("JSON.parse error",JSON.parse(e))}const r=new Date,s=function(e){const t=e.getFullYear()%100,o=n(e.getMonth()+1,2),r=n(e.getDate(),2),s=n(e.getHours(),2),a=n(e.getMinutes(),2),l=n(e.getSeconds(),2);return`${t}-${o}-${r} ${s}:${a}:${l}`}(r);o.time=s,o.id=+r-0+Math.floor(65536*(1+Math.random())).toString(16),o.even=i=!i,t(o)}function f(e,t){return e.read().then(({done:n,value:o})=>{const s=r.decode(o,{stream:!n});g+=s;const a=g.split("\n"),l=a[a.length-1];for(let e=0;e<a.length-1;e++)d(a[e],t);return n?(d(l,t),g="",console.log("GET /logs streaming done"),void(u=!1)):(g=l,f(e,t))})}function p(e){const t=Object.keys(e);return t.sort(),t.map(t=>e[t]).join("|")}function h(n,r){if("uninit"===n.logLevel)return;if(u||s&&1===s.readyState)return;a=r;const i=e(n,o);s=new WebSocket(i),s.addEventListener("error",()=>{!function(e,n){if(c&&p(e)!==l)c.abort();else if(u)return;u=!0,l=p(e),c=new AbortController;const r=c.signal,{url:s,init:a}=t(e);fetch(s+o+"?level="+e.logLevel,{...a,signal:r}).then(e=>{f(e.body.getReader(),n)},e=>{u=!1,r.aborted||console.log("GET /logs error:",e.message)})}(n,r)}),s.addEventListener("message",function(e){d(e.data,r)})}function m(){s.close(),c&&c.abort()}function v(e){a&&s&&(s.close(),u=!1,h(e,a))}export{h as f,v as r,m as s};
