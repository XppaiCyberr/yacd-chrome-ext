import{k as e,h as t,aq as r,ar as n,as as i,R as o,at as s,au as a,av as l,aw as c,ax as u,r as d,a0 as f,ay as h,L as p,a3 as m,j as v,b as g,a2 as y,B as _,u as S,d as I,g as R,C as b}from"./popup.js";import{_ as x,m as C}from"./memoize-one.esm.js";import{R as O,T as M}from"./TextFitler.js";import{f as w}from"./index2.js";import{F as z,p as T}from"./Fab.js";import{u as P}from"./useRemainingViewPortHeight.js";import"./rotate-cw.js";import"./debounce.js";var E=function(i){function o(e,t){var r;return(r=i.call(this)||this).client=e,r.setOptions(t),r.bindMethods(),r.updateResult(),r}e(o,i);var s=o.prototype;return s.bindMethods=function(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)},s.setOptions=function(e){this.options=this.client.defaultMutationOptions(e)},s.onUnsubscribe=function(){var e;this.listeners.length||(null==(e=this.currentMutation)||e.removeObserver(this))},s.onMutationUpdate=function(e){this.updateResult();var t={listeners:!0};"success"===e.type?t.onSuccess=!0:"error"===e.type&&(t.onError=!0),this.notify(t)},s.getCurrentResult=function(){return this.currentResult},s.reset=function(){this.currentMutation=void 0,this.updateResult(),this.notify({listeners:!0})},s.mutate=function(e,r){return this.mutateOptions=r,this.currentMutation&&this.currentMutation.removeObserver(this),this.currentMutation=this.client.getMutationCache().build(this.client,t({},this.options,{variables:void 0!==e?e:this.options.variables})),this.currentMutation.addObserver(this),this.currentMutation.execute()},s.updateResult=function(){var e=this.currentMutation?this.currentMutation.state:r(),n=t({},e,{isLoading:"loading"===e.status,isSuccess:"success"===e.status,isError:"error"===e.status,isIdle:"idle"===e.status,mutate:this.mutate,reset:this.reset});this.currentResult=n},s.notify=function(e){var t=this;n.batch(function(){t.mutateOptions&&(e.onSuccess?(null==t.mutateOptions.onSuccess||t.mutateOptions.onSuccess(t.currentResult.data,t.currentResult.variables,t.currentResult.context),null==t.mutateOptions.onSettled||t.mutateOptions.onSettled(t.currentResult.data,null,t.currentResult.variables,t.currentResult.context)):e.onError&&(null==t.mutateOptions.onError||t.mutateOptions.onError(t.currentResult.error,t.currentResult.variables,t.currentResult.context),null==t.mutateOptions.onSettled||t.mutateOptions.onSettled(void 0,t.currentResult.error,t.currentResult.variables,t.currentResult.context))),e.listeners&&t.listeners.forEach(function(e){e(t.currentResult)})})},o}(i);function N(e,r,i){var u=o.useRef(!1),d=o.useState(0)[1],f=s(e,r,i),h=a(),p=o.useRef();p.current?p.current.setOptions(f):p.current=new E(h,f);var m=p.current.getCurrentResult();o.useEffect(function(){u.current=!0;var e=p.current.subscribe(n.batchCalls(function(){u.current&&d(function(e){return e+1})}));return function(){u.current=!1,e()}},[]);var v=o.useCallback(function(e,t){p.current.mutate(e,t).catch(l)},[]);if(m.error&&c(void 0,p.current.options.useErrorBoundary,[m.error]))throw m.error;return t({},m,{mutate:v,mutateAsync:m.mutate})}var D="object"==typeof performance&&"function"==typeof performance.now?function(){return performance.now()}:function(){return Date.now()};function k(e){cancelAnimationFrame(e.id)}var W=-1;function F(e){if(void 0===e&&(e=!1),-1===W||e){var t=document.createElement("div"),r=t.style;r.width="50px",r.height="50px",r.overflow="scroll",document.body.appendChild(t),W=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return W}var L=null;function A(e){if(void 0===e&&(e=!1),null===L||e){var t=document.createElement("div"),r=t.style;r.width="50px",r.height="50px",r.overflow="scroll",r.direction="rtl";var n=document.createElement("div"),i=n.style;return i.width="100px",i.height="100px",t.appendChild(n),document.body.appendChild(t),t.scrollLeft>0?L="positive-descending":(t.scrollLeft=1,L=0===t.scrollLeft?"negative":"positive-ascending"),document.body.removeChild(t),L}return L}var U=function(e,t){return e};function j(r){var n,i=r.getItemOffset,o=r.getEstimatedTotalSize,s=r.getItemSize,a=r.getOffsetForIndexAndAlignment,l=r.getStartIndexForOffset,c=r.getStopIndexForStartIndex,f=r.initInstanceProps,h=r.shouldResetStyleCacheOnItemSizeChange,p=r.validateProps;return(n=function(r){function n(e){var t;return(t=r.call(this,e)||this)._instanceProps=f(t.props,u(t)),t._outerRef=void 0,t._resetIsScrollingTimeoutId=null,t.state={instance:u(t),isScrolling:!1,scrollDirection:"forward",scrollOffset:"number"==typeof t.props.initialScrollOffset?t.props.initialScrollOffset:0,scrollUpdateWasRequested:!1},t._callOnItemsRendered=void 0,t._callOnItemsRendered=C(function(e,r,n,i){return t.props.onItemsRendered({overscanStartIndex:e,overscanStopIndex:r,visibleStartIndex:n,visibleStopIndex:i})}),t._callOnScroll=void 0,t._callOnScroll=C(function(e,r,n){return t.props.onScroll({scrollDirection:e,scrollOffset:r,scrollUpdateWasRequested:n})}),t._getItemStyle=void 0,t._getItemStyle=function(e){var r,n=t.props,o=n.direction,a=n.itemSize,l=n.layout,c=t._getItemStyleCache(h&&a,h&&l,h&&o);if(c.hasOwnProperty(e))r=c[e];else{var u=i(t.props,e,t._instanceProps),d=s(t.props,e,t._instanceProps),f="horizontal"===o||"horizontal"===l,p="rtl"===o,m=f?u:0;c[e]=r={position:"absolute",left:p?void 0:m,right:p?m:void 0,top:f?0:u,height:f?"100%":d,width:f?d:"100%"}}return r},t._getItemStyleCache=void 0,t._getItemStyleCache=C(function(e,t,r){return{}}),t._onScrollHorizontal=function(e){var r=e.currentTarget,n=r.clientWidth,i=r.scrollLeft,o=r.scrollWidth;t.setState(function(e){if(e.scrollOffset===i)return null;var r=t.props.direction,s=i;if("rtl"===r)switch(A()){case"negative":s=-i;break;case"positive-descending":s=o-n-i}return s=Math.max(0,Math.min(s,o-n)),{isScrolling:!0,scrollDirection:e.scrollOffset<s?"forward":"backward",scrollOffset:s,scrollUpdateWasRequested:!1}},t._resetIsScrollingDebounced)},t._onScrollVertical=function(e){var r=e.currentTarget,n=r.clientHeight,i=r.scrollHeight,o=r.scrollTop;t.setState(function(e){if(e.scrollOffset===o)return null;var t=Math.max(0,Math.min(o,i-n));return{isScrolling:!0,scrollDirection:e.scrollOffset<t?"forward":"backward",scrollOffset:t,scrollUpdateWasRequested:!1}},t._resetIsScrollingDebounced)},t._outerRefSetter=function(e){var r=t.props.outerRef;t._outerRef=e,"function"==typeof r?r(e):null!=r&&"object"==typeof r&&r.hasOwnProperty("current")&&(r.current=e)},t._resetIsScrollingDebounced=function(){var e,r,n,i;null!==t._resetIsScrollingTimeoutId&&k(t._resetIsScrollingTimeoutId),t._resetIsScrollingTimeoutId=(e=t._resetIsScrolling,r=150,n=D(),i={id:requestAnimationFrame(function t(){D()-n>=r?e.call(null):i.id=requestAnimationFrame(t)})})},t._resetIsScrolling=function(){t._resetIsScrollingTimeoutId=null,t.setState({isScrolling:!1},function(){t._getItemStyleCache(-1,null)})},t}e(n,r),n.getDerivedStateFromProps=function(e,t){return q(e,t),p(e),null};var m=n.prototype;return m.scrollTo=function(e){e=Math.max(0,e),this.setState(function(t){return t.scrollOffset===e?null:{scrollDirection:t.scrollOffset<e?"forward":"backward",scrollOffset:e,scrollUpdateWasRequested:!0}},this._resetIsScrollingDebounced)},m.scrollToItem=function(e,t){void 0===t&&(t="auto");var r=this.props,n=r.itemCount,i=r.layout,o=this.state.scrollOffset;e=Math.max(0,Math.min(e,n-1));var s=0;if(this._outerRef){var l=this._outerRef;s="vertical"===i?l.scrollWidth>l.clientWidth?F():0:l.scrollHeight>l.clientHeight?F():0}this.scrollTo(a(this.props,e,t,o,this._instanceProps,s))},m.componentDidMount=function(){var e=this.props,t=e.direction,r=e.initialScrollOffset,n=e.layout;if("number"==typeof r&&null!=this._outerRef){var i=this._outerRef;"horizontal"===t||"horizontal"===n?i.scrollLeft=r:i.scrollTop=r}this._callPropsCallbacks()},m.componentDidUpdate=function(){var e=this.props,t=e.direction,r=e.layout,n=this.state,i=n.scrollOffset;if(n.scrollUpdateWasRequested&&null!=this._outerRef){var o=this._outerRef;if("horizontal"===t||"horizontal"===r)if("rtl"===t)switch(A()){case"negative":o.scrollLeft=-i;break;case"positive-ascending":o.scrollLeft=i;break;default:var s=o.clientWidth,a=o.scrollWidth;o.scrollLeft=a-s-i}else o.scrollLeft=i;else o.scrollTop=i}this._callPropsCallbacks()},m.componentWillUnmount=function(){null!==this._resetIsScrollingTimeoutId&&k(this._resetIsScrollingTimeoutId)},m.render=function(){var e=this.props,r=e.children,n=e.className,i=e.direction,s=e.height,a=e.innerRef,l=e.innerElementType,c=e.innerTagName,u=e.itemCount,f=e.itemData,h=e.itemKey,p=void 0===h?U:h,m=e.layout,v=e.outerElementType,g=e.outerTagName,y=e.style,_=e.useIsScrolling,S=e.width,I=this.state.isScrolling,R="horizontal"===i||"horizontal"===m,b=R?this._onScrollHorizontal:this._onScrollVertical,x=this._getRangeToRender(),C=x[0],O=x[1],M=[];if(u>0)for(var w=C;w<=O;w++)M.push(d.createElement(r,{data:f,key:p(w,f),index:w,isScrolling:_?I:void 0,style:this._getItemStyle(w)}));var z=o(this.props,this._instanceProps);return d.createElement(v||g||"div",{className:n,onScroll:b,ref:this._outerRefSetter,style:t({position:"relative",height:s,width:S,overflow:"auto",WebkitOverflowScrolling:"touch",willChange:"transform",direction:i},y)},d.createElement(l||c||"div",{children:M,ref:a,style:{height:R?"100%":z,pointerEvents:I?"none":void 0,width:R?z:"100%"}}))},m._callPropsCallbacks=function(){if("function"==typeof this.props.onItemsRendered&&this.props.itemCount>0){var e=this._getRangeToRender(),t=e[0],r=e[1],n=e[2],i=e[3];this._callOnItemsRendered(t,r,n,i)}if("function"==typeof this.props.onScroll){var o=this.state,s=o.scrollDirection,a=o.scrollOffset,l=o.scrollUpdateWasRequested;this._callOnScroll(s,a,l)}},m._getRangeToRender=function(){var e=this.props,t=e.itemCount,r=e.overscanCount,n=this.state,i=n.isScrolling,o=n.scrollDirection,s=n.scrollOffset;if(0===t)return[0,0,0,0];var a=l(this.props,s,this._instanceProps),u=c(this.props,a,s,this._instanceProps),d=i&&"backward"!==o?1:Math.max(1,r),f=i&&"forward"!==o?1:Math.max(1,r);return[Math.max(0,a-d),Math.max(0,Math.min(t-1,u+f)),a,u]},n}(d.PureComponent)).defaultProps={direction:"ltr",itemData:void 0,layout:"vertical",overscanCount:2,useIsScrolling:!1},n}var q=function(e,t){e.children,e.direction,e.height,e.layout,e.innerTagName,e.outerTagName,e.width,t.instance},H=function(e,t,r){var n=e.itemSize,i=r.itemMetadataMap,o=r.lastMeasuredIndex;if(t>o){var s=0;if(o>=0){var a=i[o];s=a.offset+a.size}for(var l=o+1;l<=t;l++){var c=n(l);i[l]={offset:s,size:c},s+=c}r.lastMeasuredIndex=t}return i[t]},$=function(e,t,r,n,i){for(;n<=r;){var o=n+Math.floor((r-n)/2),s=H(e,o,t).offset;if(s===i)return o;s<i?n=o+1:s>i&&(r=o-1)}return n>0?n-1:0},B=function(e,t,r,n){for(var i=e.itemCount,o=1;r<i&&H(e,r,t).offset<n;)r+=o,o*=2;return $(e,t,Math.min(r,i-1),Math.floor(r/2),n)},V=function(e,t){var r=e.itemCount,n=t.itemMetadataMap,i=t.estimatedItemSize,o=t.lastMeasuredIndex,s=0;if(o>=r&&(o=r-1),o>=0){var a=n[o];s=a.offset+a.size}return s+(r-o-1)*i},G=j({getItemOffset:function(e,t,r){return H(e,t,r).offset},getItemSize:function(e,t,r){return r.itemMetadataMap[t].size},getEstimatedTotalSize:V,getOffsetForIndexAndAlignment:function(e,t,r,n,i,o){var s=e.direction,a=e.height,l=e.layout,c=e.width,u="horizontal"===s||"horizontal"===l?c:a,d=H(e,t,i),f=V(e,i),h=Math.max(0,Math.min(f-u,d.offset)),p=Math.max(0,d.offset-u+d.size+o);switch("smart"===r&&(r=n>=p-u&&n<=h+u?"auto":"center"),r){case"start":return h;case"end":return p;case"center":return Math.round(p+(h-p)/2);default:return n>=p&&n<=h?n:n<p?p:h}},getStartIndexForOffset:function(e,t,r){return function(e,t,r){var n=t.itemMetadataMap,i=t.lastMeasuredIndex;return(i>0?n[i].offset:0)>=r?$(e,t,i,0,r):B(e,t,Math.max(0,i),r)}(e,r,t)},getStopIndexForStartIndex:function(e,t,r,n){for(var i=e.direction,o=e.height,s=e.itemCount,a=e.layout,l=e.width,c="horizontal"===i||"horizontal"===a?l:o,u=H(e,t,n),d=r+c,f=u.offset+u.size,h=t;h<s-1&&f<d;)h++,f+=H(e,h,n).size;return h},initInstanceProps:function(e,t){var r={itemMetadataMap:{},estimatedItemSize:e.estimatedItemSize||50,lastMeasuredIndex:-1};return t.resetAfterIndex=function(e,n){void 0===n&&(n=!0),r.lastMeasuredIndex=Math.min(r.lastMeasuredIndex,e-1),t._getItemStyleCache(-1),n&&t.forceUpdate()},r},shouldResetStyleCacheOnItemSizeChange:!1,validateProps:function(e){e.itemSize}});function K(e,t){for(var r in e)if(!(r in t))return!0;for(var n in t)if(e[n]!==t[n])return!0;return!1}var Q=["style"],J=["style"];async function X(e,t){const{url:r,init:n}=f(t);let i={providers:{}};try{const t=await fetch(r+e,n);t.ok&&(i=await t.json())}catch(o){console.log("failed to GET /providers/rules",o)}return function(e){const t=e.providers,r=Object.keys(t),n={};for(let i=0;i<r.length;i++){const e=r[i];n[e]={...t[e],idx:i}}return{byName:n,names:r}}(i)}async function Y({name:e,apiConfig:t}){const{url:r,init:n}=f(t);try{return(await fetch(r+`/providers/rules/${e}`,{method:"PUT",...n})).ok}catch(i){return console.log("failed to PUT /providers/rules/:name",i),!1}}async function Z({names:e,apiConfig:t}){for(let r=0;r<e.length;r++)await Y({name:e[r],apiConfig:t})}var ee=function(e,t,r,n,i,o,s,a){if(!e){var l;if(void 0===t)l=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[r,n,i,o,s,a],u=0;(l=new Error(t.replace(/%s/g,function(){return c[u++]}))).name="Invariant Violation"}throw l.framesToPop=1,l}};async function te(e,t){let r={rules:[]};try{const{url:n,init:i}=f(t),o=await fetch(n+e,i);o.ok&&(r=await o.json())}catch(n){console.log("failed to fetch rules",n)}return function(e){return ee(e.rules&&e.rules.length>=0,"there is no valid rules list in the rules API response"),e.rules.map((e,t)=>({...e,id:t}))}(r)}const re=h({key:"ruleFilterText",default:""});function ne(e){return p(["/providers/rules",e],()=>X("/providers/rules",e))}const ie="_RuleProviderItem_ly9yn_1",oe="_left_ly9yn_7",se="_middle_ly9yn_14",ae="_gray_ly9yn_20",le="_refreshButtonWrapper_ly9yn_24";function ce({idx:e,name:t,vehicleType:r,behavior:n,updatedAt:i,ruleCount:o,apiConfig:s}){const[l,c]=function(e,t){const r=a(),{mutate:n,isLoading:i}=N(Y,{onSuccess:()=>{r.invalidateQueries("/providers/rules")}});return[r=>{r.preventDefault(),n({name:e,apiConfig:t})},i]}(t,s),u=w(new Date(i),new Date);return v("div",{className:ie,children:[g("span",{className:oe,children:e}),v("div",{className:se,children:[g(y,{name:t,type:`${r} / ${n}`}),g("div",{className:ae,children:o<2?`${o} rule`:`${o} rules`}),v("small",{className:ae,children:["Updated ",u," ago"]})]}),g("span",{className:le,children:g(_,{onClick:l,disabled:c,children:g(O,{isRotating:c})})})]})}function ue({apiConfig:e}){const[t,r]=function(e){const t=a(),{data:r}=ne(e),{mutate:n,isLoading:i}=N(Z,{onSuccess:()=>{t.invalidateQueries("/providers/rules")}});return[t=>{t.preventDefault(),n({names:r.names,apiConfig:e})},i]}(e),{t:n}=S();return g(z,{icon:g(O,{isRotating:r}),text:n("update_all_rule_provider"),style:T,onClick:t})}const de={rule:"_rule_1e5p9_4",left:"_left_1e5p9_15",a:"_a_1e5p9_22",b:"_b_1e5p9_29",type:"_type_1e5p9_41",size:"_size_1e5p9_46",payloadAndSize:"_payloadAndSize_1e5p9_50"},fe={_default:"#59caf9",DIRECT:"#f5bc41",REJECT:"#cb3166"};function he({type:e,payload:t,proxy:r,id:n,size:i}){const o=function({proxy:e}){let t=fe._default;return fe[e]&&(t=fe[e]),{color:t}}({proxy:r});return v("div",{className:de.rule,children:[g("div",{className:de.left,children:n}),v("div",{style:{marginLeft:10},children:[v("div",{className:de.payloadAndSize,children:[g("div",{className:de.payload,children:t}),("GeoSite"===e||"GeoIP"===e)&&v("div",{style:{margin:"0 1em"},className:de.size,children:[" ","size: ",i]})]}),v("div",{className:de.a,children:[g("div",{className:de.type,children:e}),g("div",{style:o,children:r})]})]})]})}const pe="_header_10x16_4",me="_RuleProviderItemWrapper_10x16_11",{memo:ve}=o;function ge(e,{rules:t,provider:r}){const n=r.names.length;if(e<n)return r.names[e];return t[e-n].id}const ye=ve(({index:e,style:t,data:r})=>{const{rules:n,provider:i,apiConfig:o}=r,s=i.names.length;if(e<s){const r=i.names[e],n=i.byName[r];return g("div",{style:t,className:me,children:g(ce,{apiConfig:o,...n})})}const a=n[e-s];return g("div",{style:t,children:g(he,{...a})})},function(e,t){var r=e.style,n=x(e,Q),i=t.style,o=x(t,J);return!K(r,i)&&!K(n,o)}),_e=I(e=>({apiConfig:R(e)}))(function({apiConfig:e}){const[t,r]=P(),{rules:n,provider:i}=function(e){const{data:t,isFetching:r}=p(["/rules",e],()=>te("/rules",e)),{data:n}=ne(e),[i]=m(re);if(""===i)return{rules:t,provider:n,isFetching:r};{const e=i.toLowerCase();return{rules:t.filter(t=>t.payload.toLowerCase().indexOf(e)>=0),isFetching:r,provider:{byName:n.byName,names:n.names.filter(t=>t.toLowerCase().indexOf(e)>=0)}}}}(e),o=function({provider:e}){return function(t){return t<e.names.length?90:60}}({provider:i}),{t:s}=S();return v("div",{children:[v("div",{className:pe,children:[g(b,{title:s("Rules")}),g(M,{textAtom:re,placeholder:s("Search")})]}),g("div",{ref:t,style:{paddingBottom:30},children:g(G,{height:r-30,width:"100%",itemCount:n.length+i.names.length,itemSize:o,itemData:{rules:n,provider:i,apiConfig:e},itemKey:ge,children:ye})}),i&&i.names&&i.names.length>0?g(ue,{apiConfig:e}):null]})});export{_e as default};
